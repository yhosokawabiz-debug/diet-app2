// ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function switchUser(user) {
            selectUser(user);
        }<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤«å©¦ãƒ€ã‚¤ã‚¨ãƒƒãƒˆç®¡ç† - ã‚¯ãƒ©ã‚¦ãƒ‰ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 20px 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 13px;
            margin-bottom: 15px;
        }

        .user-selector {
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 10px;
            display: flex;
            gap: 5px;
        }

        .user-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 15px;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .user-btn.active {
            background: white;
            color: #333;
            font-weight: bold;
        }

        .sync-status {
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 11px;
            display: inline-block;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            margin-top: 10px;
            padding: 3px;
        }

        .nav-tab {
            flex: 1;
            padding: 8px 4px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .nav-tab.active {
            background: white;
            color: #333;
            font-weight: bold;
        }

        .content {
            padding: 20px;
            padding-bottom: 100px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .setup-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .setup-step {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            text-align: left;
        }

        .step-number {
            background: white;
            color: #ff6b6b;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            margin-right: 10px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .stat-label {
            color: rgba(255,255,255,0.9);
            font-size: 13px;
        }

        .advice-card {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .advice-title {
            font-size: 16px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .advice-text {
            color: rgba(255,255,255,0.95);
            font-size: 14px;
            line-height: 1.5;
        }

        .progress-ring {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
        }

        .progress-ring circle {
            fill: transparent;
            stroke: rgba(255,255,255,0.3);
            stroke-width: 8;
        }

        .progress-ring .progress {
            stroke: white;
            stroke-dasharray: 0 251;
            transition: stroke-dasharray 0.5s;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79,172,254,0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #fa709a, #fee140);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79,172,254,0.3);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
            margin-bottom: 5px;
            border-radius: 10px;
        }

        .history-date {
            font-weight: bold;
            color: #666;
        }

        .history-weight {
            font-size: 18px;
            font-weight: bold;
            color: #4facfe;
        }

        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .success {
            background: #2ed573;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .code-box {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            font-family: monospace;
            word-break: break-all;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .emoji {
            font-size: 18px;
        }

        @media (max-width: 480px) {
            .stat-value {
                font-size: 24px;
            }
            
            .nav-tab {
                font-size: 11px;
                padding: 6px 2px;
            }
            
            .user-btn {
                font-size: 12px;
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘« å¤«å©¦ãƒ€ã‚¤ã‚¨ãƒƒãƒˆç®¡ç†</h1>
            <p class="subtitle">ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã§å®‰å¿ƒãƒ»å®‰å…¨</p>
            
            <div class="user-selector" id="userSelector">
                <div class="loading">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            
            <div class="sync-status" id="syncStatus">ğŸ”„ æ¥ç¶šç¢ºèªä¸­...</div>
            
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showTab('users')">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</div>
                <div class="nav-tab" onclick="showTab('setup')">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</div>
                <div class="nav-tab" onclick="showTab('dashboard')">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
                <div class="nav-tab" onclick="showTab('input')">ä½“é‡å…¥åŠ›</div>
                <div class="nav-tab" onclick="showTab('history')">å±¥æ­´</div>
            </div>
        </div>

        <div class="content">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† -->
            <div id="users" class="tab-content active">
                <div class="setup-card">
                    <h3>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
                    <p>ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚’ç®¡ç†ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ãƒ»é¸æŠã§ãã¾ã™</p>
                </div>

                <div class="input-group">
                    <label class="input-label">æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ </label>
                    <input type="text" id="newUserName" class="input-field" placeholder="ä¾‹: å¤ªéƒã€èŠ±å­ã€ãƒãƒã€ãƒ‘ãƒ‘">
                </div>

                <button class="btn btn-secondary" onclick="addNewUser()">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ </button>

                <div id="userList" style="margin-top: 20px;">
                    <div class="loading">ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>

                <div id="userResult"></div>
            </div>

            <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— -->
            <div id="setup" class="tab-content">
                <div class="setup-card">
                    <h3>ğŸš€ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h3>
                    <p>Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨é€£æºã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«ä¿å­˜ã—ã¾ã—ã‚‡ã†</p>
                </div>

                <div class="setup-step">
                    <div><span class="step-number">1</span><strong>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ</strong></div>
                    <p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€å°‚ç”¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
                    <button class="btn btn-secondary" onclick="createSpreadsheet()" style="margin-top: 10px;">
                        ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ
                    </button>
                </div>

                <div class="setup-step">
                    <div><span class="step-number">2</span><strong>Google Apps Script è¨­å®š</strong></div>
                    <p>ä½œæˆã—ãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ã€Apps Scriptã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
                    <button class="copy-btn" onclick="copyGASCode()">ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
                </div>

                <div class="setup-step">
                    <div><span class="step-number">3</span><strong>ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLè¨­å®š</strong></div>
                    <p>ãƒ‡ãƒ—ãƒ­ã‚¤ã§å–å¾—ã—ãŸURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    <input type="url" id="webAppUrl" class="input-field" placeholder="https://script.google.com/..." style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="testConnection()" style="margin-top: 10px;">
                        ğŸ”— æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    </button>
                </div>

                <div id="connectionResult"></div>
            </div>

            <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            <div id="dashboard" class="tab-content">
                <div id="dashboardContent">
                    <div class="loading">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- ä½“é‡å…¥åŠ› -->
            <div id="input" class="tab-content">
                <div class="input-group">
                    <label class="input-label">æ¸¬å®šæ—¥</label>
                    <input type="date" id="measureDate" class="input-field">
                </div>

                <div class="input-group">
                    <label class="input-label">ä½“é‡ (kg)</label>
                    <input type="number" id="measureWeight" class="input-field" step="0.1" placeholder="ä¾‹: 65.5">
                </div>

                <button class="btn btn-primary" onclick="addWeightRecord()">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«è¨˜éŒ²</button>
                <div id="inputResult"></div>
            </div>

            <!-- å±¥æ­´ -->
            <div id="history" class="tab-content">
                <div id="historyList">
                    <div class="loading">ğŸ“‹ å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let webAppUrl = '';
        let currentUser = '';
        let userList = [];
        let dietData = { settings: {}, records: [] };

        // åˆæœŸåŒ–
        function init() {
            const savedUrl = localStorage.getItem('webAppUrl');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedUrl) {
                webAppUrl = savedUrl;
                document.getElementById('webAppUrl').value = savedUrl;
                loadUserList();
            }
            
            if (savedUser) {
                currentUser = savedUser;
            }
            
            setDefaultDate();
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadUserList() {
            if (!webAppUrl) return;

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getUserList' })
                });

                if (response.ok) {
                    userList = await response.json();
                    renderUserList();
                    updateUserSelector();
                    
                    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¦ã€ãƒªã‚¹ãƒˆã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                    if (currentUser && userList.includes(currentUser)) {
                        loadAllData();
                    }
                } else {
                    console.error('Failed to load user list');
                }
            } catch (error) {
                console.error('Error loading user list:', error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
        function renderUserList() {
            const userListElement = document.getElementById('userList');
            
            if (userList.length === 0) {
                userListElement.innerHTML = '<div class="loading">ã¾ã ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            userListElement.innerHTML = `
                <h4 style="margin-bottom: 15px;">ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼</h4>
                ${userList.map(user => `
                    <div class="history-item">
                        <div class="history-date">${user}</div>
                        <button class="btn-primary" onclick="selectUser('${user}')" style="padding: 8px 15px; font-size: 14px;">
                            ${user === currentUser ? 'âœ… é¸æŠä¸­' : 'é¸æŠ'}
                        </button>
                    </div>
                `).join('')}
            `;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ›´æ–°
        function updateUserSelector() {
            const userSelector = document.getElementById('userSelector');
            
            if (userList.length === 0) {
                userSelector.innerHTML = '<div class="loading">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
                return;
            }

            userSelector.innerHTML = userList.map(user => `
                <button class="user-btn ${user === currentUser ? 'active' : ''}" onclick="switchUser('${user}')" id="user-${user}">
                    ${user}
                </button>
            `).join('');
        }

        // æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
        async function addNewUser() {
            const userName = document.getElementById('newUserName').value.trim();
            
            if (!userName) {
                showResult('userResult', 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!webAppUrl) {
                showResult('userResult', 'âŒ å…ˆã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (userList.includes(userName)) {
                showResult('userResult', 'âŒ ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™', 'error');
                return;
            }

            showResult('userResult', 'ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ä¸­...', 'loading');

            try {
                // è¨­å®šã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveSettings',
                        user: userName,
                        startWeight: 0,
                        targetWeight: 0,
                        startDate: '',
                        targetDate: ''
                    })
                });

                if (response.ok) {
                    showResult('userResult', 'âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼', 'success');
                    document.getElementById('newUserName').value = '';
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                    await loadUserList();
                    
                    // è¿½åŠ ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•é¸æŠ
                    selectUser(userName);
                } else {
                    throw new Error('è¿½åŠ ã‚¨ãƒ©ãƒ¼');
                }
            } catch (error) {
                showResult('userResult', 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ
        function selectUser(user) {
            currentUser = user;
            localStorage.setItem('currentUser', user);
            
            renderUserList();
            updateUserSelector();
            loadAllData();
            
            showResult('userResult', `âœ… ${user}ã•ã‚“ã‚’é¸æŠã—ã¾ã—ãŸ`, 'success');
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜è¨­å®š
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('measureDate').value = today;
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ
        function createSpreadsheet() {
            const url = 'https://docs.google.com/spreadsheets/create';
            window.open(url, '_blank');
        }

        // GASã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
        function copyGASCode() {
            const code = `function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const data = JSON.parse(e.postData.contents);
  const action = data.action;
  const user = data.user || 'ã¿ã¡ã“';
  
  if (action === 'saveSettings') {
    const settingsSheet = getOrCreateSheet(ss, \`\${user}è¨­å®š\`);
    settingsSheet.getRange('A1:B4').setValues([
      ['ã‚¹ã‚¿ãƒ¼ãƒˆä½“é‡', data.startWeight],
      ['ç›®æ¨™ä½“é‡', data.targetWeight],
      ['é–‹å§‹æ—¥', data.startDate],
      ['ç›®æ¨™æœŸæ—¥', data.targetDate]
    ]);
    return ContentService.createTextOutput(JSON.stringify({success: true}));
  }
  
  if (action === 'getSettings') {
    const settingsSheet = getOrCreateSheet(ss, \`\${user}è¨­å®š\`);
    const values = settingsSheet.getRange('A1:B4').getValues();
    const settings = {};
    values.forEach(row => {
      if (row[0] === 'ã‚¹ã‚¿ãƒ¼ãƒˆä½“é‡') settings.startWeight = row[1];
      if (row[0] === 'ç›®æ¨™ä½“é‡') settings.targetWeight = row[1];
      if (row[0] === 'é–‹å§‹æ—¥') settings.startDate = row[1];
      if (row[0] === 'ç›®æ¨™æœŸæ—¥') settings.targetDate = row[1];
    });
    return ContentService.createTextOutput(JSON.stringify(settings));
  }
  
  if (action === 'addRecord') {
    const recordsSheet = getOrCreateSheet(ss, \`\${user}è¨˜éŒ²\`);
    const existingData = recordsSheet.getRange('A:B').getValues();
    let updated = false;
    
    for (let i = 1; i < existingData.length; i++) {
      if (existingData[i][0] && new Date(existingData[i][0]).toDateString() === new Date(data.date).toDateString()) {
        recordsSheet.getRange(i + 1, 2).setValue(data.weight);
        updated = true;
        break;
      }
    }
    
    if (!updated) {
      recordsSheet.appendRow([new Date(data.date), data.weight]);
    }
    
    return ContentService.createTextOutput(JSON.stringify({success: true}));
  }
  
  if (action === 'getRecords') {
    const recordsSheet = getOrCreateSheet(ss, \`\${user}è¨˜éŒ²\`);
    const data = recordsSheet.getRange('A:B').getValues();
    const records = [];
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][1]) {
        records.push({
          date: Utilities.formatDate(new Date(data[i][0]), 'JST', 'yyyy-MM-dd'),
          weight: data[i][1]
        });
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify(records));
  }
  
  if (action === 'deleteRecord') {
    const recordsSheet = getOrCreateSheet(ss, \`\${user}è¨˜éŒ²\`);
    const allData = recordsSheet.getRange('A:B').getValues();
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0] && new Date(allData[i][0]).toDateString() === new Date(data.date).toDateString()) {
        recordsSheet.deleteRow(i + 1);
        break;
      }
    }
    return ContentService.createTextOutput(JSON.stringify({success: true}));
  }
}

function getOrCreateSheet(ss, name) {
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    if (name.endsWith('è¨˜éŒ²')) {
      sheet.getRange('A1:B1').setValues([['æ—¥ä»˜', 'ä½“é‡']]);
      sheet.getRange('A1:B1').setFontWeight('bold');
    }
  }
  return sheet;
}`;
            
            navigator.clipboard.writeText(code).then(() => {
                alert('ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            });
        }

        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testConnection() {
            const url = document.getElementById('webAppUrl').value.trim();
            if (!url) {
                showResult('connectionResult', 'URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showResult('connectionResult', 'ğŸ”„ æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­...', 'loading');

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getSettings', user: currentUser })
                });

                if (response.ok) {
                    webAppUrl = url;
                    localStorage.setItem('webAppUrl', url);
                    showResult('connectionResult', 'âœ… æ¥ç¶šæˆåŠŸï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ–ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„', 'success');
                    updateSyncStatus('âœ… æ¥ç¶šæ¸ˆã¿');
                    loadUserList();
                } else {
                    throw new Error('æ¥ç¶šã‚¨ãƒ©ãƒ¼');
                }
            } catch (error) {
                showResult('connectionResult', 'âŒ æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
                updateSyncStatus('âŒ æœªæ¥ç¶š');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAllData() {
            if (!webAppUrl || !currentUser) return;

            try {
                updateSyncStatus('ğŸ”„ åŒæœŸä¸­...');
                
                // è¨­å®šãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const settingsResponse = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getSettings', user: currentUser })
                });
                
                if (settingsResponse.ok) {
                    dietData.settings = await settingsResponse.json();
                }

                // è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const recordsResponse = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getRecords', user: currentUser })
                });
                
                if (recordsResponse.ok) {
                    dietData.records = await recordsResponse.json();
                }

                updateSyncStatus('âœ… åŒæœŸå®Œäº†');
                updateDashboard();
                renderHistory();
                
            } catch (error) {
                updateSyncStatus('âŒ åŒæœŸã‚¨ãƒ©ãƒ¼');
                console.error('Data load error:', error);
            }
        }

        // ä½“é‡è¨˜éŒ²è¿½åŠ 
        async function addWeightRecord() {
            if (!webAppUrl) {
                showResult('inputResult', 'âŒ å…ˆã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!currentUser) {
                showResult('inputResult', 'âŒ å…ˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const date = document.getElementById('measureDate').value;
            const weight = parseFloat(document.getElementById('measureWeight').value);
            
            if (!date || !weight) {
                showResult('inputResult', 'âŒ æ—¥ä»˜ã¨ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showResult('inputResult', 'â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ä¸­...', 'loading');

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'addRecord',
                        user: currentUser,
                        date: date,
                        weight: weight
                    })
                });

                if (response.ok) {
                    showResult('inputResult', 'âœ… è¨˜éŒ²ã—ã¾ã—ãŸï¼', 'success');
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                    const existingIndex = dietData.records.findIndex(r => r.date === date);
                    if (existingIndex >= 0) {
                        dietData.records[existingIndex].weight = weight;
                    } else {
                        dietData.records.push({ date, weight });
                        dietData.records.sort((a, b) => new Date(a.date) - new Date(b.date));
                    }

                    updateDashboard();
                    
                    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('measureWeight').value = '';
                    
                    // æ¬¡ã®æ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
                    const nextDay = new Date(date);
                    nextDay.setDate(nextDay.getDate() + 1);
                    document.getElementById('measureDate').value = nextDay.toISOString().split('T')[0];
                    
                } else {
                    throw new Error('ä¿å­˜ã‚¨ãƒ©ãƒ¼');
                }
            } catch (error) {
                showResult('inputResult', 'âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // è¨˜éŒ²å‰Šé™¤
        async function deleteRecord(date) {
            if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'deleteRecord',
                        user: currentUser,
                        date: date
                    })
                });

                if (response.ok) {
                    dietData.records = dietData.records.filter(r => r.date !== date);
                    updateDashboard();
                    renderHistory();
                }
            } catch (error) {
                alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        function generateAdvice(settings, records) {
            if (!settings.targetWeight || !settings.targetDate || records.length === 0) {
                return null;
            }

            const currentWeight = records[records.length - 1].weight;
            const remaining = currentWeight - settings.targetWeight;
            const today = new Date();
            const targetDate = new Date(settings.targetDate);
            const daysLeft = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysLeft <= 0) {
                return {
                    emoji: 'ğŸ¯',
                    title: 'ç›®æ¨™æœŸæ—¥åˆ°é”ï¼',
                    text: `ç›®æ¨™æœŸæ—¥ã«ãªã‚Šã¾ã—ãŸï¼ç¾åœ¨ã®ä½“é‡ã¯${currentWeight.toFixed(1)}kgã§ã™ã€‚ç›®æ¨™é”æˆã¾ã§ã‚ã¨${remaining.toFixed(1)}kgã§ã™ã€‚`
                };
            }

            const neededDaily = remaining > 0 ? (remaining * 1000) / daysLeft : 0;
            
            if (remaining <= 0) {
                return {
                    emoji: 'ğŸ‰',
                    title: 'ç›®æ¨™é”æˆãŠã‚ã§ã¨ã†ï¼',
                    text: `ç›®æ¨™ä½“é‡ã‚’${Math.abs(remaining).toFixed(1)}kgä¸Šå›ã£ã¦é”æˆã—ã¦ã„ã¾ã™ï¼ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ï¼`
                };
            }

            if (neededDaily > 500) {
                return {
                    emoji: 'âš ï¸',
                    title: 'è¦æ³¨æ„ï¼ãƒšãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ãŒå¿…è¦',
                    text: `ç›®æ¨™é”æˆã«ã¯1æ—¥ã‚ãŸã‚Š${Math.round(neededDaily)}gæ¸›é‡ãŒå¿…è¦ã§ã™ã€‚ç¾å®Ÿçš„ãªç›®æ¨™ã«è¦‹ç›´ã™ã‹ã€ã‚ˆã‚Šç©æ¥µçš„ãªå–ã‚Šçµ„ã¿ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`
                };
            } else if (neededDaily > 200) {
                return {
                    emoji: 'ğŸ’ª',
                    title: 'ã‚‚ã†ä¸€è¸ã‚“å¼µã‚Šï¼',
                    text: `ç›®æ¨™é”æˆã«ã¯1æ—¥ã‚ãŸã‚Š${Math.round(neededDaily)}gæ¸›é‡ãŒå¿…è¦ã§ã™ã€‚é£Ÿäº‹ç®¡ç†ã¨é‹å‹•ã‚’ç¶™ç¶šã™ã‚Œã°é”æˆå¯èƒ½ã§ã™ï¼`
                };
            } else {
                return {
                    emoji: 'ğŸ˜Š',
                    title: 'é †èª¿ãªãƒšãƒ¼ã‚¹ã§ã™',
                    text: `ç›®æ¨™é”æˆã«ã¯1æ—¥ã‚ãŸã‚Š${Math.round(neededDaily)}gæ¸›é‡ã§ååˆ†ã§ã™ã€‚ç¾åœ¨ã®ãƒšãƒ¼ã‚¹ã‚’ç¶­æŒã™ã‚Œã°é”æˆã§ããã†ã§ã™ï¼`
                };
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateDashboard() {
            const { settings, records } = dietData;
            
            if (!settings.startWeight || records.length === 0) {
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="setup-card">
                        <h3>ğŸ“Š ${currentUser}ã•ã‚“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>
                        <p>è¨­å®šã¨ä½“é‡è¨˜éŒ²ã‚’è¿½åŠ ã™ã‚‹ã¨ã€é€²æ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                `;
                return;
            }
            
            const currentWeight = records[records.length - 1].weight;
            const weightLoss = settings.startWeight - currentWeight;
            const remaining = currentWeight - settings.targetWeight;
            
            const today = new Date();
            const startDate = new Date(settings.startDate);
            const targetDate = new Date(settings.targetDate);
            
            const daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const daysLeft = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));
            
            const avgDaily = daysElapsed > 0 ? (weightLoss * 1000) / daysElapsed : 0;
            const projectedWeight = daysLeft > 0 ? currentWeight - (avgDaily * daysLeft / 1000) : currentWeight;
            const gap = projectedWeight - settings.targetWeight;
            const neededDaily = daysLeft > 0 ? (remaining * 1000) / daysLeft : 0;

            // é€²æ—ç‡è¨ˆç®—
            const totalLoss = settings.startWeight - settings.targetWeight;
            const progressRate = Math.min(100, (weightLoss / totalLoss) * 100);

            // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
            const advice = generateAdvice(settings, records);

            document.getElementById('dashboardContent').innerHTML = `
                <div class="stat-card">
                    <h3 style="color: white; margin-bottom: 15px;">${currentUser}ã•ã‚“ã®é€²æ—</h3>
                    <svg class="progress-ring" viewBox="0 0 80 80">
                        <circle cx="40" cy="40" r="36"></circle>
                        <circle cx="40" cy="40" r="36" class="progress" style="stroke-dasharray: ${progressRate * 2.26} 226;"></circle>
                        <text x="40" y="45" text-anchor="middle" style="fill: white; font-size: 14px; font-weight: bold;">${Math.round(progressRate)}%</text>
                    </svg>
                    <div class="stat-label">ç›®æ¨™é”æˆç‡</div>
                </div>
                
                ${advice ? `
                <div class="advice-card">
                    <div class="advice-title">
                        <span class="emoji">${advice.emoji}</span>
                        ${advice.title}
                    </div>
                    <div class="advice-text">${advice.text}</div>
                </div>
                ` : ''}
                
                <div class="stat-card">
                    <div class="stat-value">${currentWeight.toFixed(1)}</div>
                    <div class="stat-label">ç¾åœ¨ã®ä½“é‡ (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${weightLoss.toFixed(1)}</div>
                    <div class="stat-label">æ¸›é‡æ¸ˆã¿ (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${remaining.toFixed(1)}</div>
                    <div class="stat-label">ç›®æ¨™ã¾ã§æ®‹ã‚Š (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${daysElapsed}</div>
                    <div class="stat-label">çµŒéæ—¥æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(avgDaily)}</div>
                    <div class="stat-label">1æ—¥å¹³å‡æ¸›é‡ (g)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${daysLeft}</div>
                    <div class="stat-label">ç›®æ¨™æœŸæ—¥ã¾ã§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${projectedWeight.toFixed(1)}</div>
                    <div class="stat-label">äºˆæƒ³ä½“é‡ (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${gap.toFixed(1)}</div>
                    <div class="stat-label">ç›®æ¨™ã¨ã®ã‚®ãƒ£ãƒƒãƒ— (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(neededDaily)}</div>
                    <div class="stat-label">å¿…è¦ãªæ—¥æ¬¡æ¸›é‡ (g)</div>
                </div>
            `;
        }

        // å±¥æ­´è¡¨ç¤º
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            if (dietData.records.length === 0) {
                historyList.innerHTML = `<div class="loading">${currentUser}ã•ã‚“ã®è¨˜éŒ²ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
                return;
            }
            
            const sortedRecords = [...dietData.records].reverse();
            
            historyList.innerHTML = sortedRecords.map(record => `
                <div class="history-item">
                    <div class="history-date">${formatDate(record.date)}</div>
                    <div class="history-weight">${record.weight}kg</div>
                    <button class="delete-btn" onclick="deleteRecord('${record.date}')">å‰Šé™¤</button>
                </div>
            `).join('');
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'history') {
                renderHistory();
            }
            if (tabName === 'dashboard') {
                updateDashboard();
            }
            if (tabName === 'users') {
                renderUserList();
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function updateSyncStatus(status) {
            document.getElementById('syncStatus').textContent = status;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
