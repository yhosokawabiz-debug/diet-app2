<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çª„Ç≠„É•„Ç¢Â§´Â©¶„ÉÄ„Ç§„Ç®„ÉÉ„ÉàÁÆ°ÁêÜ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 20px 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .admin-badge {
            background: rgba(255,215,0,0.9);
            color: #333;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 10px;
            cursor: pointer;
        }

        .user-selector {
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .user-btn {
            flex: 1;
            min-width: 60px;
            padding: 6px 8px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 11px;
            position: relative;
        }

        .user-btn.active {
            background: white;
            color: #333;
            font-weight: bold;
        }

        .user-btn.protected::after {
            content: 'üîí';
            position: absolute;
            top: -2px;
            right: -2px;
            font-size: 8px;
        }

        .sync-status {
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 4px 8px;
            font-size: 10px;
            display: inline-block;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            margin-top: 10px;
            padding: 3px;
        }

        .nav-tab {
            flex: 1;
            padding: 6px 2px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 10px;
        }

        .nav-tab.active {
            background: white;
            color: #333;
            font-weight: bold;
        }

        .content {
            padding: 20px;
            padding-bottom: 100px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .login-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            margin-top: 50px;
        }

        .setup-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .setup-step {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            text-align: left;
        }

        .step-number {
            background: white;
            color: #ff6b6b;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            margin-right: 10px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .stat-label {
            color: rgba(255,255,255,0.9);
            font-size: 12px;
        }

        .advice-card {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .advice-title {
            font-size: 16px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .advice-text {
            color: rgba(255,255,255,0.95);
            font-size: 14px;
            line-height: 1.5;
        }

        .progress-ring {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
        }

        .progress-ring circle {
            fill: transparent;
            stroke: rgba(255,255,255,0.3);
            stroke-width: 8;
        }

        .progress-ring .progress {
            stroke: white;
            stroke-dasharray: 0 251;
            transition: stroke-dasharray 0.5s;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79,172,254,0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #fa709a, #fee140);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: white;
        }

        .btn-admin {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79,172,254,0.3);
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 2px solid #f0f0f0;
            background: white;
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .user-item.admin {
            border-color: #ffd700;
            background: linear-gradient(135deg, #fff5cc 0%, #ffeb99 100%);
        }

        .user-name {
            font-weight: bold;
            color: #333;
        }

        .user-role {
            font-size: 12px;
            color: #666;
            margin-left: 8px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-small.select {
            background: #4facfe;
            color: white;
        }

        .btn-small.delete {
            background: #ff4757;
            color: white;
        }

        .btn-small.selected {
            background: #2ed573;
            color: white;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
            margin-bottom: 5px;
            border-radius: 10px;
        }

        .history-date {
            font-weight: bold;
            color: #666;
        }

        .history-weight {
            font-size: 18px;
            font-weight: bold;
            color: #4facfe;
        }

        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .success {
            background: #2ed573;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .code-box {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            font-family: monospace;
            word-break: break-all;
            margin-bottom: 15px;
            font-size: 11px;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 350px;
            width: 90%;
            text-align: center;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .emoji {
            font-size: 18px;
        }

        @media (max-width: 480px) {
            .stat-value {
                font-size: 20px;
            }
            
            .nav-tab {
                font-size: 9px;
                padding: 4px 1px;
            }
            
            .user-btn {
                font-size: 10px;
                padding: 4px 6px;
            }
        }
    </style>
</head>
<body>
    <!-- „É≠„Ç∞„Ç§„É≥„É¢„Éº„ÉÄ„É´ -->
    <div id="loginModal" class="modal show">
        <div class="modal-content">
            <h3>üîê „É≠„Ç∞„Ç§„É≥</h3>
            <div class="input-group">
                <label class="input-label">„É¶„Éº„Ç∂„ÉºÂêç</label>
                <input type="text" id="loginUser" class="input-field" placeholder="„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ">
            </div>
            <div class="input-group">
                <label class="input-label">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                <input type="password" id="loginPassword" class="input-field" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
            </div>
            <button class="btn btn-primary" onclick="login()">„É≠„Ç∞„Ç§„É≥</button>
            <button class="btn btn-admin" onclick="adminLogin()">üëë ÁÆ°ÁêÜËÄÖ„Å®„Åó„Å¶„É≠„Ç∞„Ç§„É≥</button>
        </div>
    </div>

    <!-- „Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>üîí „Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ</h3>
            <p id="passwordPrompt"></p>
            <div class="input-group">
                <input type="password" id="userPassword" class="input-field" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
            </div>
            <button class="btn btn-primary" onclick="verifyPassword()">Á¢∫Ë™ç</button>
            <button class="btn btn-secondary" onclick="closePasswordModal()">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üîê „Çª„Ç≠„É•„Ç¢Â§´Â©¶„ÉÄ„Ç§„Ç®„ÉÉ„ÉàÁÆ°ÁêÜ</h1>
            <p class="subtitle">„Éó„É©„Ç§„Éê„Ç∑„Éº‰øùË≠∑„Éª„ÇØ„É©„Ç¶„ÉâÂêåÊúü</p>
            
            <div id="adminBadge" class="admin-badge" style="display: none;">üëë ÁÆ°ÁêÜËÄÖ„É¢„Éº„Éâ</div>
            
            <div class="user-info">
                <span id="currentUserDisplay">Êú™„É≠„Ç∞„Ç§„É≥</span>
                <button class="logout-btn" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
            
            <div class="user-selector" id="userSelector">
                <div class="loading">üë§ „É¶„Éº„Ç∂„Éº„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
            
            <div class="sync-status" id="syncStatus">üîÑ Êé•Á∂öÁ¢∫Ë™ç‰∏≠...</div>
            
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showTab('users')">„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</div>
                <div class="nav-tab" onclick="showTab('setup')">„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó</div>
                <div class="nav-tab" onclick="showTab('dashboard')">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</div>
                <div class="nav-tab" onclick="showTab('input')">‰ΩìÈáçÂÖ•Âäõ</div>
                <div class="nav-tab" onclick="showTab('history')">Â±•Ê≠¥</div>
            </div>
        </div>

        <div class="content">
            <!-- „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ -->
            <div id="users" class="tab-content active">
                <div class="setup-card">
                    <h3>üë§ „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</h3>
                    <p>„Éó„É©„Ç§„Éê„Ç∑„Éº‰øùË≠∑„Åß„ÉÄ„Ç§„Ç®„ÉÉ„Éà„ÇíÁÆ°ÁêÜ</p>
                </div>

                <div id="adminUserSection" style="display: none;">
                    <div class="input-group">
                        <label class="input-label">Êñ∞„Åó„ÅÑ„É¶„Éº„Ç∂„Éº„ÇíËøΩÂä†</label>
                        <input type="text" id="newUserName" class="input-field" placeholder="‰æã: Â§™ÈÉé„ÄÅËä±Â≠ê„ÄÅ„Éû„Éû„ÄÅ„Éë„Éë">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">„Éë„Çπ„ÉØ„Éº„ÉâË®≠ÂÆö</label>
                        <input type="password" id="newUserPassword" class="input-field" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
                    </div>

                    <button class="btn btn-secondary" onclick="addNewUser()">üë§ „É¶„Éº„Ç∂„Éº„ÇíËøΩÂä†</button>
                </div>

                <div id="userList" style="margin-top: 20px;">
                    <div class="loading">üîÑ „É¶„Éº„Ç∂„Éº‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>

                <div id="userResult"></div>
            </div>

            <!-- „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó -->
            <div id="setup" class="tab-content">
                <div class="setup-card">
                    <h3>üöÄ ÂàùÊúü„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó</h3>
                    <p>Google „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å®ÈÄ£Êê∫„Åó„Å¶„Éá„Éº„Çø„ÇíÂÆâÂÖ®„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Çá„ÅÜ</p>
                </div>

                <div class="setup-step">
                    <div><span class="step-number">1</span><strong>„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà‰ΩúÊàê</strong></div>
                    <p>‰∏ã„ÅÆ„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÄÅÂ∞ÇÁî®„ÅÆ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    <button class="btn btn-secondary" onclick="createSpreadsheet()" style="margin-top: 10px;">
                        üìä „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà‰ΩúÊàê
                    </button>
                </div>

                <div class="setup-step">
                    <div><span class="step-number">2</span><strong>Google Apps Script Ë®≠ÂÆö</strong></div>
                    <p>‰ΩúÊàê„Åó„Åü„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åß„ÄÅApps Script„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    <button class="copy-btn" onclick="copyGASCode()">üìã „Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº</button>
                </div>

                <div class="setup-step">
                    <div><span class="step-number">3</span><strong>„Ç¶„Çß„Éñ„Ç¢„Éó„É™URLË®≠ÂÆö</strong></div>
                    <p>„Éá„Éó„É≠„Ç§„ÅßÂèñÂæó„Åó„ÅüURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    <input type="url" id="webAppUrl" class="input-field" placeholder="https://script.google.com/..." style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="testConnection()" style="margin-top: 10px;">
                        üîó Êé•Á∂ö„ÉÜ„Çπ„Éà
                    </button>
                </div>

                <div id="connectionResult"></div>
            </div>

            <!-- „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
            <div id="dashboard" class="tab-content">
                <div id="dashboardContent">
                    <div class="loading">üìä „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>

            <!-- ‰ΩìÈáçÂÖ•Âäõ -->
            <div id="input" class="tab-content">
                <div class="input-group">
                    <label class="input-label">Ê∏¨ÂÆöÊó•</label>
                    <input type="date" id="measureDate" class="input-field">
                </div>

                <div class="input-group">
                    <label class="input-label">‰ΩìÈáç (kg)</label>
                    <input type="number" id="measureWeight" class="input-field" step="0.1" placeholder="‰æã: 65.5">
                </div>

                <button class="btn btn-primary" onclick="addWeightRecord()">‚òÅÔ∏è „ÇØ„É©„Ç¶„Éâ„Å´Ë®òÈå≤</button>
                <div id="inputResult"></div>
            </div>

            <!-- Â±•Ê≠¥ -->
            <div id="history" class="tab-content">
                <div id="historyList">
                    <div class="loading">üìã Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let webAppUrl = '';
        let currentUser = '';
        let userList = [];
        let isAdmin = false;
        let userPasswords = {};
        let dietData = { settings: {}, records: [] };
        let pendingUserSwitch = null;

        // ÁÆ°ÁêÜËÄÖ„ÅÆ„Éá„Éï„Ç©„É´„Éà„Éë„Çπ„ÉØ„Éº„Éâ
        const ADMIN_PASSWORD = 'admin123';

        // ÂàùÊúüÂåñ
        function init() {
            const savedUrl = localStorage.getItem('webAppUrl');
            
            if (savedUrl) {
                webAppUrl = savedUrl;
                document.getElementById('webAppUrl').value = savedUrl;
                loadUserList();
            }
            
            setDefaultDate();
            
            // ÂàùÂõû„Ç¢„ÇØ„Çª„ÇπÊôÇ„ÅØ„É≠„Ç∞„Ç§„É≥„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            showModal('loginModal');
        }

        // „É≠„Ç∞„Ç§„É≥
        function login() {
            const username = document.getElementById('loginUser').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                alert('„É¶„Éº„Ç∂„ÉºÂêç„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!webAppUrl) {
                alert('ÂÖà„Å´„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç
            verifyUserPassword(username, password).then(valid => {
                if (valid) {
                    currentUser = username;
                    isAdmin = false;
                    localStorage.setItem('currentUser', username);
                    
                    closeModal('loginModal');
                    updateUI();
                    loadAllData();
                } else {
                    alert('‚ùå „É¶„Éº„Ç∂„ÉºÂêç„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô');
                }
            });
        }

        // ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥
        function adminLogin() {
            const password = document.getElementById('loginPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                currentUser = 'ÁÆ°ÁêÜËÄÖ';
                isAdmin = true;
                localStorage.setItem('currentUser', 'ÁÆ°ÁêÜËÄÖ');
                localStorage.setItem('isAdmin', 'true');
                
                closeModal('loginModal');
                updateUI();
                loadUserList();
            } else {
                alert('‚ùå ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô');
            }
        }

        // „É≠„Ç∞„Ç¢„Ç¶„Éà
        function logout() {
            currentUser = '';
            isAdmin = false;
            dietData = { settings: {}, records: [] };
            
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isAdmin');
            
            showModal('loginModal');
            updateUI();
            
            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // UIÊõ¥Êñ∞
        function updateUI() {
            const userDisplay = document.getElementById('currentUserDisplay');
            const adminBadge = document.getElementById('adminBadge');
            const adminSection = document.getElementById('adminUserSection');
            
            if (isAdmin) {
                userDisplay.textContent = 'üëë ÁÆ°ÁêÜËÄÖ';
                adminBadge.style.display = 'inline-block';
                adminSection.style.display = 'block';
            } else {
                userDisplay.textContent = `üë§ ${currentUser}`;
                adminBadge.style.display = 'none';
                adminSection.style.display = 'none';
            }
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫„ÉªÈùûË°®Á§∫
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function closePasswordModal() {
            closeModal('passwordModal');
            pendingUserSwitch = null;
        }

        // „É¶„Éº„Ç∂„Éº‰∏ÄË¶ßË™≠„ÅøËæº„Åø
        async function loadUserList() {
            if (!webAppUrl) return;

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getUserList' })
                });

                if (response.ok) {
                    const result = await response.json();
                    userList = result.users || [];
                    userPasswords = result.passwords || {};
                    
                    renderUserList();
                    updateUserSelector();
                } else {
                    console.error('Failed to load user list');
                }
            } catch (error) {
                console.error('Error loading user list:', error);
            }
        }

        // „É¶„Éº„Ç∂„Éº‰∏ÄË¶ßË°®Á§∫
        function renderUserList() {
            const userListElement = document.getElementById('userList');
            
            if (userList.length === 0) {
                userListElement.innerHTML = '<div class="loading">„Åæ„Å†„É¶„Éº„Ç∂„Éº„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
                return;
            }

            userListElement.innerHTML = `
                <h4 style="margin-bottom: 15px;">ÁôªÈå≤Ê∏à„Åø„É¶„Éº„Ç∂„Éº</h4>
                ${userList.map(user => `
                    <div class="user-item ${user === 'ÁÆ°ÁêÜËÄÖ' ? 'admin' : ''}">
                        <div>
                            <span class="user-name">${user}</span>
                            ${user === 'ÁÆ°ÁêÜËÄÖ' ? '<span class="user-role">üëë ÁÆ°ÁêÜËÄÖ</span>' : '<span class="user-role">üîí „Éë„Çπ„ÉØ„Éº„Éâ‰øùË≠∑</span>'}
                        </div>
                        <div class="user-actions">
                            ${user === currentUser ? 
                                '<button class="btn-small selected">‚úÖ ÈÅ∏Êäû‰∏≠</button>' :
                                `<button class="btn-small select" onclick="requestUserSwitch('${user}')">ÈÅ∏Êäû</button>`
                            }
                            ${isAdmin && user !== 'ÁÆ°ÁêÜËÄÖ' ? 
                                `<button class="btn-small delete" onclick="deleteUser('${user}')">ÂâäÈô§</button>` : ''
                            }
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // „É¶„Éº„Ç∂„Éº„Çª„É¨„ÇØ„Çø„ÉºÊõ¥Êñ∞
        function updateUserSelector() {
            const userSelector = document.getElementById('userSelector');
            
            if (userList.length === 0) {
                userSelector.innerHTML = '<div class="loading">üë§ „É¶„Éº„Ç∂„Éº„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }

            const visibleUsers = isAdmin ? userList : userList.filter(user => user === currentUser || user === 'ÁÆ°ÁêÜËÄÖ');
            
            userSelector.innerHTML = visibleUsers.map(user => `
                <button class="user-btn ${user === currentUser ? 'active' : ''} ${user !== 'ÁÆ°ÁêÜËÄÖ' && user !== currentUser ? 'protected' : ''}" 
                        onclick="requestUserSwitch('${user}')" id="user-${user}">
                    ${user === 'ÁÆ°ÁêÜËÄÖ' ? 'üëë' : ''}${user}
                </button>
            `).join('');
        }

        // „É¶„Éº„Ç∂„ÉºÂàá„ÇäÊõø„ÅàË¶ÅÊ±Ç
        function requestUserSwitch(user) {
            if (user === currentUser) return;
            
            if (isAdmin || user === 'ÁÆ°ÁêÜËÄÖ') {
                // ÁÆ°ÁêÜËÄÖ„ÅØËá™Áî±„Å´Âàá„ÇäÊõø„ÅàÂèØËÉΩ
                switchUser(user);
            } else {
                // ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅØ„Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ„ÅåÂøÖË¶Å
                pendingUserSwitch = user;
                document.getElementById('passwordPrompt').textContent = `${user}„Åï„Çì„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
                showModal('passwordModal');
            }
        }

        // „Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç
        function verifyPassword() {
            const password = document.getElementById('userPassword').value;
            
            if (!password) {
                alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            verifyUserPassword(pendingUserSwitch, password).then(valid => {
                if (valid) {
                    switchUser(pendingUserSwitch);
                    closePasswordModal();
                    document.getElementById('userPassword').value = '';
                } else {
                    alert('‚ùå „Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô');
                }
            });
        }

        // „É¶„Éº„Ç∂„Éº„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç
        async function verifyUserPassword(username, password) {
            if (username === 'ÁÆ°ÁêÜËÄÖ') {
                return password === ADMIN_PASSWORD;
            }

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'verifyPassword',
                        username: username,
                        password: password
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.valid;
                }
            } catch (error) {
                console.error('Password verification error:', error);
            }
            
            return false;
        }

        // „É¶„Éº„Ç∂„ÉºÂàá„ÇäÊõø„Åà
        function switchUser(user) {
            currentUser = user;
            isAdmin = (user === 'ÁÆ°ÁêÜËÄÖ');
            localStorage.setItem('currentUser', user);
            localStorage.setItem('isAdmin', isAdmin ? 'true' : 'false');
            
            updateUI();
            renderUserList();
            updateUserSelector();
            loadAllData();
            
            showResult('userResult', `‚úÖ ${user}${isAdmin ? 'ÔºàÁÆ°ÁêÜËÄÖÔºâ' : '„Åï„Çì'}„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü`, 'success');
        }

        // Êñ∞„Åó„ÅÑ„É¶„Éº„Ç∂„ÉºËøΩÂä†
        async function addNewUser() {
            const userName = document.getElementById('newUserName').value.trim();
            const password = document.getElementById('newUserPassword').value;
            
            if (!userName || !password) {
                showResult('userResult', '‚ùå „É¶„Éº„Ç∂„ÉºÂêç„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            if (!webAppUrl) {
                showResult('userResult', '‚ùå ÂÖà„Å´„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            if (userList.includes(userName)) {
                showResult('userResult', '‚ùå „Åù„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô', 'error');
                return;
            }

            showResult('userResult', 'üë§ „É¶„Éº„Ç∂„Éº„ÇíËøΩÂä†‰∏≠...', 'loading');

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'addUser',
                        username: userName,
                        password: password
                    })
                });

                if (response.ok) {
                    showResult('userResult', '‚úÖ „É¶„Éº„Ç∂„Éº„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                    document.getElementById('newUserName').value = '';
                    document.getElementById('newUserPassword').value = '';
                    
                    await loadUserList();
                } else {
                    throw new Error('ËøΩÂä†„Ç®„É©„Éº');
                }
            } catch (error) {
                showResult('userResult', '‚ùå „É¶„Éº„Ç∂„Éº„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „É¶„Éº„Ç∂„ÉºÂâäÈô§
        async function deleteUser(username) {
            if (!confirm(`${username}„Åï„Çì„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n‚ÄªË®òÈå≤„Éá„Éº„Çø„ÇÇÂÖ®„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô`)) {
                return;
            }

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'deleteUser',
                        username: username
                    })
                });

                if (response.ok) {
                    showResult('userResult', `‚úÖ ${username}„Åï„Çì„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
                    await loadUserList();
                } else {
                    throw new Error('ÂâäÈô§„Ç®„É©„Éº');
                }
            } catch (error) {
                showResult('userResult', '‚ùå „É¶„Éº„Ç∂„Éº„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „Éá„Éï„Ç©„É´„ÉàÊó•‰ªòË®≠ÂÆö
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('measureDate').value = today;
        }

        // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà‰ΩúÊàê
        function createSpreadsheet() {
            const url = 'https://docs.google.com/spreadsheets/create';
            window.open(url, '_blank');
        }

        // GAS„Ç≥„Éº„Éâ„Ç≥„Éî„Éº
        function copyGASCode() {
            const code = `function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const data = JSON.parse(e.postData.contents);
  const action = data.action;
  
  if (action === 'getUserList') {
    return getUserList(ss);
  }
  
  if (action === 'addUser') {
    return addUser(ss, data.username, data.password);
  }
  
  if (action === 'deleteUser') {
    return deleteUser(ss, data.username);
  }
  
  if (action === 'verifyPassword') {
    return verifyPassword(ss, data.username, data.password);
  }
  
  const user = data.user;
  if (!user) {
    return ContentService.createTextOutput(JSON.stringify({error: 'User not specified'}));
  }
  
  if (action === 'saveSettings') {
    const settingsSheet = getOrCreateSheet(ss, \`\${user}Ë®≠ÂÆö\`);
    settingsSheet.getRange('A1:B4').setValues([
      ['„Çπ„Çø„Éº„Éà‰ΩìÈáç', data.startWeight],
      ['ÁõÆÊ®ô‰ΩìÈáç', data.targetWeight],
      ['ÈñãÂßãÊó•', data.startDate],
      ['ÁõÆÊ®ôÊúüÊó•', data.targetDate]
    ]);
    return ContentService.createTextOutput(JSON.stringify({success: true}));
  }
  
  if (action === 'getSettings') {
    const settingsSheet = getOrCreateSheet(ss, \`\${user}Ë®≠ÂÆö\`);
    const values = settingsSheet.getRange('A1:B4').getValues();
    const settings = {};
    values.forEach(row => {
      if (row[0] === '„Çπ„Çø„Éº„Éà‰ΩìÈáç') settings.startWeight = row[1];
      if (row[0] === 'ÁõÆÊ®ô‰ΩìÈáç') settings.targetWeight = row[1];
      if (row[0] === 'ÈñãÂßãÊó•') settings.startDate = row[1];
      if (row[0] === 'ÁõÆÊ®ôÊúüÊó•') settings.targetDate = row[1];
    });
    return ContentService.createTextOutput(JSON.stringify(settings));
  }
  
  if (action === 'addRecord') {
    const recordsSheet = getOrCreateSheet(ss, \`\${user}Ë®òÈå≤\`);
    const existingData = recordsSheet.getRange('A:B').getValues();
    let updated = false;
    
    for (let i = 1; i < existingData.length; i++) {
      if (existingData[i][0] && new Date(existingData[i][0]).toDateString() === new Date(data.date).toDateString()) {
        recordsSheet.getRange(i + 1, 2).setValue(data.weight);
        updated = true;
        break;
      }
    }
    
    if (!updated) {
      recordsSheet.appendRow([new Date(data.date), data.weight]);
    }
    
    return ContentService.createTextOutput(JSON.stringify({success: true}));
  }
  
  if (action === 'getRecords') {
    const recordsSheet = getOrCreateSheet(ss, \`\${user}Ë®òÈå≤\`);
    const data = recordsSheet.getRange('A:B').getValues();
    const records = [];
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][1]) {
        records.push({
          date: Utilities.formatDate(new Date(data[i][0]), 'JST', 'yyyy-MM-dd'),
          weight: data[i][1]
        });
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify(records));
  }
  
  if (action === 'deleteRecord') {
    const recordsSheet = getOrCreateSheet(ss, \`\${user}Ë®òÈå≤\`);
    const allData = recordsSheet.getRange('A:B').getValues();
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0] && new Date(allData[i][0]).toDateString() === new Date(data.date).toDateString()) {
        recordsSheet.deleteRow(i + 1);
        break;
      }
    }
    return ContentService.createTextOutput(JSON.stringify({success: true}));
  }
}

function getUserList(ss) {
  const userSheet = getOrCreateSheet(ss, '„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ');
  const data = userSheet.getRange('A:B').getValues();
  const users = ['ÁÆ°ÁêÜËÄÖ'];
  const passwords = {};
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] && data[i][1]) {
      users.push(data[i][0]);
      passwords[data[i][0]] = data[i][1];
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({users, passwords}));
}

function addUser(ss, username, password) {
  const userSheet = getOrCreateSheet(ss, '„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ');
  userSheet.appendRow([username, password]);
  
  // Ë®≠ÂÆö„Ç∑„Éº„Éà„ÇÇ‰ΩúÊàê
  const settingsSheet = getOrCreateSheet(ss, \`\${username}Ë®≠ÂÆö\`);
  
  return ContentService.createTextOutput(JSON.stringify({success: true}));
}

function deleteUser(ss, username) {
  const userSheet = getOrCreateSheet(ss, '„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ');
  const data = userSheet.getRange('A:C').getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === username) {
      userSheet.deleteRow(i + 1);
      break;
    }
  }
  
  // Èñ¢ÈÄ£„Ç∑„Éº„Éà„ÇÇÂâäÈô§
  try {
    const settingsSheet = ss.getSheetByName(\`\${username}Ë®≠ÂÆö\`);
    if (settingsSheet) ss.deleteSheet(settingsSheet);
    
    const recordsSheet = ss.getSheetByName(\`\${username}Ë®òÈå≤\`);
    if (recordsSheet) ss.deleteSheet(recordsSheet);
  } catch (e) {
    // „Ç∑„Éº„Éà„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}));
}

function verifyPassword(ss, username, password) {
  if (username === 'ÁÆ°ÁêÜËÄÖ') {
    return ContentService.createTextOutput(JSON.stringify({valid: password === 'admin123'}));
  }
  
  const userSheet = getOrCreateSheet(ss, '„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ');
  const data = userSheet.getRange('A:B').getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === username && data[i][1] === password) {
      return ContentService.createTextOutput(JSON.stringify({valid: true}));
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({valid: false}));
}

function getOrCreateSheet(ss, name) {
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    if (name.endsWith('Ë®òÈå≤')) {
      sheet.getRange('A1:B1').setValues([['Êó•‰ªò', '‰ΩìÈáç']]);
      sheet.getRange('A1:B1').setFontWeight('bold');
    } else if (name === '„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ') {
      sheet.getRange('A1:B1').setValues([['„É¶„Éº„Ç∂„ÉºÂêç', '„Éë„Çπ„ÉØ„Éº„Éâ']]);
      sheet.getRange('A1:B1').setFontWeight('bold');
    }
  }
  return sheet;
}`;
            
            navigator.clipboard.writeText(code).then(() => {
                alert('üìã „Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
            });
        }

        // Êé•Á∂ö„ÉÜ„Çπ„Éà
        async function testConnection() {
            const url = document.getElementById('webAppUrl').value.trim();
            if (!url) {
                showResult('connectionResult', 'URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            showResult('connectionResult', 'üîÑ Êé•Á∂ö„Çí„ÉÜ„Çπ„Éà‰∏≠...', 'loading');

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getUserList' })
                });

                if (response.ok) {
                    webAppUrl = url;
                    localStorage.setItem('webAppUrl', url);
                    showResult('connectionResult', '‚úÖ Êé•Á∂öÊàêÂäüÔºÅ„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Åß„É¶„Éº„Ç∂„Éº„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'success');
                    updateSyncStatus('‚úÖ Êé•Á∂öÊ∏à„Åø');
                    loadUserList();
                } else {
                    throw new Error('Êé•Á∂ö„Ç®„É©„Éº');
                }
            } catch (error) {
                showResult('connectionResult', '‚ùå Êé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇURL„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                updateSyncStatus('‚ùå Êú™Êé•Á∂ö');
            }
        }

        // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadAllData() {
            if (!webAppUrl || !currentUser || currentUser === 'ÁÆ°ÁêÜËÄÖ') return;

            try {
                updateSyncStatus('üîÑ ÂêåÊúü‰∏≠...');
                
                const settingsResponse = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getSettings', user: currentUser })
                });
                
                if (settingsResponse.ok) {
                    dietData.settings = await settingsResponse.json();
                }

                const recordsResponse = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getRecords', user: currentUser })
                });
                
                if (recordsResponse.ok) {
                    dietData.records = await recordsResponse.json();
                }

                updateSyncStatus('‚úÖ ÂêåÊúüÂÆå‰∫Ü');
                updateDashboard();
                renderHistory();
                
            } catch (error) {
                updateSyncStatus('‚ùå ÂêåÊúü„Ç®„É©„Éº');
                console.error('Data load error:', error);
            }
        }

        // ‰ΩìÈáçË®òÈå≤ËøΩÂä†
        async function addWeightRecord() {
            if (!webAppUrl) {
                showResult('inputResult', '‚ùå ÂÖà„Å´„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            if (!currentUser || currentUser === 'ÁÆ°ÁêÜËÄÖ') {
                showResult('inputResult', '‚ùå „É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            const date = document.getElementById('measureDate').value;
            const weight = parseFloat(document.getElementById('measureWeight').value);
            
            if (!date || !weight) {
                showResult('inputResult', '‚ùå Êó•‰ªò„Å®‰ΩìÈáç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            showResult('inputResult', '‚òÅÔ∏è „ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò‰∏≠...', 'loading');

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'addRecord',
                        user: currentUser,
                        date: date,
                        weight: weight
                    })
                });

                if (response.ok) {
                    showResult('inputResult', '‚úÖ Ë®òÈå≤„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                    
                    const existingIndex = dietData.records.findIndex(r => r.date === date);
                    if (existingIndex >= 0) {
                        dietData.records[existingIndex].weight = weight;
                    } else {
                        dietData.records.push({ date, weight });
                        dietData.records.sort((a, b) => new Date(a.date) - new Date(b.date));
                    }

                    updateDashboard();
                    
                    document.getElementById('measureWeight').value = '';
                    
                    const nextDay = new Date(date);
                    nextDay.setDate(nextDay.getDate() + 1);
                    document.getElementById('measureDate').value = nextDay.toISOString().split('T')[0];
                    
                } else {
                    throw new Error('‰øùÂ≠ò„Ç®„É©„Éº');
                }
            } catch (error) {
                showResult('inputResult', '‚ùå ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // Ë®òÈå≤ÂâäÈô§
        async function deleteRecord(date) {
            if (!confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'deleteRecord',
                        user: currentUser,
                        date: date
                    })
                });

                if (response.ok) {
                    dietData.records = dietData.records.filter(r => r.date !== date);
                    updateDashboard();
                    renderHistory();
                }
            } catch (error) {
                alert('‚ùå ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // „Ç¢„Éâ„Éê„Ç§„ÇπÁîüÊàê
        function generateAdvice(settings, records) {
            if (!settings.targetWeight || !settings.targetDate || records.length === 0) {
                return null;
            }

            const currentWeight = records[records.length - 1].weight;
            const remaining = currentWeight - settings.targetWeight;
            const today = new Date();
            const targetDate = new Date(settings.targetDate);
            const daysLeft = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysLeft <= 0) {
                return {
                    emoji: 'üéØ',
                    title: 'ÁõÆÊ®ôÊúüÊó•Âà∞ÈÅîÔºÅ',
                    text: `ÁõÆÊ®ôÊúüÊó•„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅÁèæÂú®„ÅÆ‰ΩìÈáç„ÅØ${currentWeight.toFixed(1)}kg„Åß„Åô„ÄÇÁõÆÊ®ôÈÅîÊàê„Åæ„Åß„ÅÇ„Å®${remaining.toFixed(1)}kg„Åß„Åô„ÄÇ`
                };
            }

            const neededDaily = remaining > 0 ? (remaining * 1000) / daysLeft : 0;
            
            if (remaining <= 0) {
                return {
                    emoji: 'üéâ',
                    title: 'ÁõÆÊ®ôÈÅîÊàê„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ',
                    text: `ÁõÆÊ®ô‰ΩìÈáç„Çí${Math.abs(remaining).toFixed(1)}kg‰∏äÂõû„Å£„Å¶ÈÅîÊàê„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑÊàêÊûú„Åß„ÅôÔºÅ`
                };
            }

            if (neededDaily > 500) {
                return {
                    emoji: '‚ö†Ô∏è',
                    title: 'Ë¶ÅÊ≥®ÊÑèÔºÅ„Éö„Éº„Çπ„Ç¢„ÉÉ„Éó„ÅåÂøÖË¶Å',
                    text: `ÁõÆÊ®ôÈÅîÊàê„Å´„ÅØ1Êó•„ÅÇ„Åü„Çä${Math.round(neededDaily)}gÊ∏õÈáè„ÅåÂøÖË¶Å„Åß„Åô„ÄÇÁèæÂÆüÁöÑ„Å™ÁõÆÊ®ô„Å´Ë¶ãÁõ¥„Åô„Åã„ÄÅ„Çà„ÇäÁ©çÊ•µÁöÑ„Å™Âèñ„ÇäÁµÑ„Åø„ÅåÂøÖË¶Å„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ`
                };
            } else if (neededDaily > 200) {
                return {
                    emoji: 'üí™',
                    title: '„ÇÇ„ÅÜ‰∏ÄË∏è„ÇìÂºµ„ÇäÔºÅ',
                    text: `ÁõÆÊ®ôÈÅîÊàê„Å´„ÅØ1Êó•„ÅÇ„Åü„Çä${Math.round(neededDaily)}gÊ∏õÈáè„ÅåÂøÖË¶Å„Åß„Åô„ÄÇÈ£ü‰∫ãÁÆ°ÁêÜ„Å®ÈÅãÂãï„ÇíÁ∂ôÁ∂ö„Åô„Çå„Å∞ÈÅîÊàêÂèØËÉΩ„Åß„ÅôÔºÅ`
                };
            } else {
                return {
                    emoji: 'üòä',
                    title: 'È†ÜË™ø„Å™„Éö„Éº„Çπ„Åß„Åô',
                    text: `ÁõÆÊ®ôÈÅîÊàê„Å´„ÅØ1Êó•„ÅÇ„Åü„Çä${Math.round(neededDaily)}gÊ∏õÈáè„ÅßÂçÅÂàÜ„Åß„Åô„ÄÇÁèæÂú®„ÅÆ„Éö„Éº„Çπ„ÇíÁ∂≠ÊåÅ„Åô„Çå„Å∞ÈÅîÊàê„Åß„Åç„Åù„ÅÜ„Åß„ÅôÔºÅ`
                };
            }
        }

        // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊõ¥Êñ∞
        function updateDashboard() {
            const { settings, records } = dietData;
            
            if (!currentUser || currentUser === 'ÁÆ°ÁêÜËÄÖ') {
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="setup-card">
                        <h3>üìä „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h3>
                        <p>„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„ÉÄ„Ç§„Ç®„ÉÉ„ÉàÈÄ≤Êçó„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                `;
                return;
            }
            
            if (!settings.startWeight || records.length === 0) {
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="setup-card">
                        <h3>üìä ${currentUser}„Åï„Çì„ÅÆ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h3>
                        <p>Ë®≠ÂÆö„Å®‰ΩìÈáçË®òÈå≤„ÇíËøΩÂä†„Åô„Çã„Å®„ÄÅÈÄ≤Êçó„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
                    </div>
                `;
                return;
            }
            
            const currentWeight = records[records.length - 1].weight;
            const weightLoss = settings.startWeight - currentWeight;
            const remaining = currentWeight - settings.targetWeight;
            
            const today = new Date();
            const startDate = new Date(settings.startDate);
            const targetDate = new Date(settings.targetDate);
            
            const daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const daysLeft = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));
            
            const avgDaily = daysElapsed > 0 ? (weightLoss * 1000) / daysElapsed : 0;
            const projectedWeight = daysLeft > 0 ? currentWeight - (avgDaily * daysLeft / 1000) : currentWeight;
            const gap = projectedWeight - settings.targetWeight;
            const neededDaily = daysLeft > 0 ? (remaining * 1000) / daysLeft : 0;

            const totalLoss = settings.startWeight - settings.targetWeight;
            const progressRate = Math.min(100, (weightLoss / totalLoss) * 100);

            const advice = generateAdvice(settings, records);

            document.getElementById('dashboardContent').innerHTML = `
                <div class="stat-card">
                    <h3 style="color: white; margin-bottom: 15px;">${currentUser}„Åï„Çì„ÅÆÈÄ≤Êçó</h3>
                    <svg class="progress-ring" viewBox="0 0 80 80">
                        <circle cx="40" cy="40" r="36"></circle>
                        <circle cx="40" cy="40" r="36" class="progress" style="stroke-dasharray: ${progressRate * 2.26} 226;"></circle>
                        <text x="40" y="45" text-anchor="middle" style="fill: white; font-size: 14px; font-weight: bold;">${Math.round(progressRate)}%</text>
                    </svg>
                    <div class="stat-label">ÁõÆÊ®ôÈÅîÊàêÁéá</div>
                </div>
                
                ${advice ? `
                <div class="advice-card">
                    <div class="advice-title">
                        <span class="emoji">${advice.emoji}</span>
                        ${advice.title}
                    </div>
                    <div class="advice-text">${advice.text}</div>
                </div>
                ` : ''}
                
                <div class="stat-card">
                    <div class="stat-value">${currentWeight.toFixed(1)}</div>
                    <div class="stat-label">ÁèæÂú®„ÅÆ‰ΩìÈáç (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${weightLoss.toFixed(1)}</div>
                    <div class="stat-label">Ê∏õÈáèÊ∏à„Åø (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${remaining.toFixed(1)}</div>
                    <div class="stat-label">ÁõÆÊ®ô„Åæ„ÅßÊÆã„Çä (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${daysElapsed}</div>
                    <div class="stat-label">ÁµåÈÅéÊó•Êï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(avgDaily)}</div>
                    <div class="stat-label">1Êó•Âπ≥ÂùáÊ∏õÈáè (g)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${daysLeft}</div>
                    <div class="stat-label">ÁõÆÊ®ôÊúüÊó•„Åæ„Åß</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${projectedWeight.toFixed(1)}</div>
                    <div class="stat-label">‰∫àÊÉ≥‰ΩìÈáç (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${gap.toFixed(1)}</div>
                    <div class="stat-label">ÁõÆÊ®ô„Å®„ÅÆ„ÇÆ„É£„ÉÉ„Éó (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(neededDaily)}</div>
                    <div class="stat-label">ÂøÖË¶Å„Å™Êó•Ê¨°Ê∏õÈáè (g)</div>
                </div>
            `;
        }

        // Â±•Ê≠¥Ë°®Á§∫
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            if (!currentUser || currentUser === 'ÁÆ°ÁêÜËÄÖ') {
                historyList.innerHTML = '<div class="loading">„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }
            
            if (dietData.records.length === 0) {
                historyList.innerHTML = `<div class="loading">${currentUser}„Åï„Çì„ÅÆË®òÈå≤„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
                return;
            }
            
            const sortedRecords = [...dietData.records].reverse();
            
            historyList.innerHTML = sortedRecords.map(record => `
                <div class="history-item">
                    <div class="history-date">${formatDate(record.date)}</div>
                    <div class="history-weight">${record.weight}kg</div>
                    <button class="delete-btn" onclick="deleteRecord('${record.date}')">ÂâäÈô§</button>
                </div>
            `).join('');
        }

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'history') {
                renderHistory();
            }
            if (tabName === 'dashboard') {
                updateDashboard();
            }
            if (tabName === 'users') {
                renderUserList();
            }
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function updateSyncStatus(status) {
            document.getElementById('syncStatus').textContent = status;
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
        window.addEventListener('load', init);
    </script>
</body>
</html>
